{% extends "base.html" %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <h4>Visualizador 2D del Espacio Semántico</h4>
        <hr>

        {% if total_vectors > 0 %}
        <div class="alert alert-info py-2">
            <small>
                <strong>Estadísticas:</strong> {{ total_vectors }} vectores |
                Varianza explicada: {{ "%.2f" | format(plot_data.explained_variance * 100) }}% |
                Tiempo de carga: {{ load_time }}
            </small>
        </div>
        {% endif %}

        <form method="POST" class="row g-3 align-items-end">
            <div class="col-md-5">
                <label for="language" class="form-label">Filtrar por idioma:</label>
                <select class="form-select" id="language" name="language">
                    <option value="all" {% if selected_lang == 'all' %}selected{% endif %}>
                        Todos los idiomas
                    </option>
                    {% for code, name in languages.items() %}
                    <option value="{{ code }}" {% if selected_lang == code %}selected{% endif %}>
                        {{ name }} ({{ code }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label for="max_words" class="form-label">Cantidad de palabras:</label>
                <select class="form-select" id="max_words" name="max_words">
                    <option value="100" {% if max_words == 100 %}selected{% endif %}>100 palabras</option>
                    <option value="250" {% if max_words == 200 %}selected{% endif %}>200 palabras</option>
                    <option value="500" {% if max_words == 500 %}selected{% endif %}>500 palabras</option>
                    <option value="1000" {% if max_words == 1000 %}selected{% endif %}>1000 palabras</option>
                    <option value="2500" {% if max_words == 2500 %}selected{% endif %}>2500 palabras</option>
                    <option value="5000" {% if max_words == 5000 %}selected{% endif %}>5000 palabras</option>
                    <option value="10000" {% if max_words == 10000 %}selected{% endif %}>10000 palabras</option>
                </select>
            </div>

            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">Actualizar</button>
            </div>
        </form>
    </div>
</div>

{% if plot_data %}
<div class="card">
    <div class="card-body">
        <div id="embedding-plot" style="height: 600px;"></div>
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <h6>Esperando datos...</h6>
    <p class="mb-0">Si esto persiste, ejecuta: <code>python main.py</code></p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
{% if plot_data %}
document.addEventListener('DOMContentLoaded', function() {
    const data = {{ plot_data|tojson }};
    const languages = {{ languages|tojson }};

    // Predefined colors for each language
    const colorMap = {};
    const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2'];
    let colorIdx = 0;

    // Group points by language
    const langGroups = {};
    data.languages.forEach((lang, i) => {
        if (!langGroups[lang]) {
            langGroups[lang] = {
                x: [], y: [],
                words: [],
                color: colors[colorIdx++ % colors.length]
            };
        }
        langGroups[lang].x.push(data.x[i]);
        langGroups[lang].y.push(data.y[i]);
        langGroups[lang].words.push(data.words[i]);
    });

    // Create a trace for each language
    const traces = Object.entries(langGroups).map(([lang, group]) => ({
        name: languages[lang] || lang,
        type: 'scatter',
        mode: 'markers+text',
        x: group.x,
        y: group.y,
        text: group.words,
        textposition: 'top center',
        marker: {
            size: 8,
            color: group.color,
            opacity: 0.7,
            line: { width: 1, color: 'white' }
        },
        customdata: group.words,
        hovertemplate: '<b>%{customdata}</b><br>(' + (languages[lang] || lang) + ')<extra></extra>'
    }));

    const layout = {
        title: 'Espacio Semántico Vectorial (2D PCA)',
        xaxis: {
            title: 'Componente Principal 1',
            gridcolor: '#f0f0f0',
            zerolinecolor: '#d0d0d0'
        },
        yaxis: {
            title: 'Componente Principal 2',
            gridcolor: '#f0f0f0',
            zerolinecolor: '#d0d0d0'
        },
        hovermode: 'closest',
        margin: { l: 50, r: 50, b: 50, t: 60 },
        plot_bgcolor: 'white',
        paper_bgcolor: 'white'
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
        displaylogo: false
    };

    Plotly.newPlot('embedding-plot', traces, layout, config);
});
{% endif %}
</script>
{% endblock %}